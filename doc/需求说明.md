# DMPlay-v4 播放器需求说明文档

> 技术栈：Vue 3 + Artplayer4（结合 hls.js、flv.js、dash.js、webtorrent、mpegts.js 等播放库）

## 一、项目概述

开发一个兼容 PC 与移动端的网页播放器，基于 Artplayer，实现 HLS、FLV、DASH、WebTorrent、mpegts 等多种流媒体格式播放；集成弹幕、广告、在线人数显示、机器人求片抽屉、远程配置下发等功能，界面美观、移动端友好。

## 二、关键功能

1. 基础播放控制（已具备）
   - 播放 / 暂停 / 跳转 / 音量 / 全屏 / 画中画 / 进度条 / 画面比例 等。
2. 格式支持（必须）
   - HLS（hls.js）
   - FLV（flv.js）
   - DASH（dash.js）
   - WebTorrent（webtorrent）
   - mpegts（mpegts.js）
   - 以上格式需在 npm 上安装对应库（见后面依赖清单）并在 Artplayer 中按需启用插件/adapter。
3. 弹幕
   - 使用 npm 包：`artplayer-plugin-danmuku`（或 artplayer 官方推荐插件）
   - 支持拉取弹幕列表、发送弹幕接口、黑词过滤、提示文案、开关控制等
4. 在线人数角标（左下）
   - 常驻左下角，颜色淡雅（半透明背景、浅色文字），接口：
     https://dmplay.knowhub.vip/Online/Index?timespan=...&urlEncry=...
   - 接口返回格式：`{"code":1,"data":38}`，当 code=1 时显示 data
   - 定时刷新（例如每 15-30 秒）并平滑更新数字
5. 基础配置下发
   - 接口：https://dmplay.knowhub.vip/api/v1.0/dmplay/config?timespan=...&urlEncry=...
   - 返回结构示例（摘录）包含 ad、notice、danmuOn、danmuApi、toolBars 等
   - 在播放器初始化时拉取配置并据此：
     - 注入 pageAd 脚本（注意安全与沙箱）
     - 显示 notice（顶部滚动白色文字，右侧显示倒计时 30s，可提前关闭）
     - 初始化 toolBars（在控制栏上添加按钮，支持 icon 或 title、link）
     - 拷贝 copywriting 到剪贴板（随机选择一项）
     - 控制 danmu 功能开关和 danmuApi
6. 广告系统
   - 接口：GET https://dmplay.knowhub.vip/api/v1.0/Ads/Index?id=1&platform=web... 返回 {width,height,Script,CloseCode,ID,Weight}
   - 展示逻辑：根据 Weight 概率决定是否展示，按 width/height 限定尺寸，Script 中的代码执行/注入，CloseCode 为可选关闭逻辑
   - 支持启动广告（startAds）、暂停广告（pauseAds）等
7. 求片机器人抽屉
   - 点击“求片”按钮弹出抽屉（PC 侧边抽屉；移动端弹出 full-screen modal/page）
   - 弹出时暂停播放，关闭时恢复播放
   - 抽屉内为聊天窗口：输入关键词调用搜索接口，展示搜索结果；点击结果请求影片资源（POST /dmjx/index?id=...），并在播放器上切换资源（支持多线路与备用列表）
8. 选集/线路切换
   - 支持 assets 数组展示（半透明覆盖层或弹出菜单），点击切换至对应 url
   - 自动失败重试：当前 URL 播放失败时自动尝试 assets 列表的下一个
9. 加载过渡图（友好效果）
   - 接口：GET https://dmplay.knowhub.vip/api/v1.0/cover/images
   - 返回图片数组，播放器加载/缓冲时随机显示一张并每 3 秒切换
   - 可使用 Artplayer 的 loading 插件或自定义 overlay 实现

## 三、API 细节（已知）

### timespan & urlEncry 参数说明

- **timespan**：当前系统时间戳（毫秒，`Date.now()`）
- **urlEncry**：所有参数升序排列后拼接字符串，取 md5 值。
  - 生成方法：
    1. 获取 url 查询参数（不含 urlEncry），每项拼接为 key+value
    2. 追加额外参数（如 timespan）
    3. 所有 key+value 组成数组，按字典序排序
    4. 用英文逗号 `,` 连接
    5. 对结果字符串做 md5 得到 urlEncry
  - 示例代码：

```js
function getUrlEncry(urlStr, values) {
  let url = ''
  if (typeof urlStr === 'undefined') {
    url = decodeURI(location.search)
  } else {
    const arr = urlStr.split('?')
    if (arr.length >= 2) {
      let q = arr[1] || ''
      if (q !== '') {
        url = '?' + q
      }
    }
  }
  let querys = []
  if (url.indexOf('?') !== -1) {
    var str = url.substr(1)
    let strs = str.split('&')
    for (var i = 0; i < strs.length; i++) {
      let arr = strs[i].split('=')
      if (arr[0] === 'urlEncry') {
        continue
      }
      querys.push(arr[0] + decodeURI(arr[1]))
    }
  }
  for (var v in values) {
    querys.push(v + values[v])
  }
  querys = querys.sort(function (a, b) {
    return a.localeCompare(b)
  })
  let res = querys.join(',')
  let md5Str = md5lib(res)
  return md5Str
}
```

- 依赖：需引入 md5 库（如 `md5` npm 包或自定义 md5lib）

- 在线人数：
  - GET https://dmplay.knowhub.vip/Online/Index?timespan=...&urlEncry=...
  - 返回：{"code":1,"data":38}
- 配置：
  - GET https://dmplay.knowhub.vip/api/v1.0/dmplay/config?timespan=...&urlEncry=...
  - 返回示例见需求描述（包含 ad、notice、danmu...）
- 广告：
  - GET https://dmplay.knowhub.vip/api/v1.0/Ads/Index?id=1&platform=web&timespan=...&urlEncry=...
  - POST 广告上报/点击（如需）
- 弹幕：
  - GET https://dmplay.knowhub.vip/api/v1.0/Danmu?id=&timespan=...&urlEncry=...
  - POST https://dmplay.knowhub.vip/api/v1.0/Danmu（body JSON: text, mode, color, vodId, time）
- 聊天求片：
  - GET https://dmplay.knowhub.vip/api/v1.0/Chat/Index?qes=...&timespan=...&urlEncry=...
  - POST https://dmplay.knowhub.vip/api/v1.0/dmjx/index (body: id=...) 返回资源列表

注意：所有跨域请求需后端配置 CORS 或前端通过代理转发；需要对接口错误/超时做容错处理。

## 四、UI / 交互与移动端适配

1. 通用风格
   - 大气、简洁、以深色或暗色主题为主（更适合视频场景）
   - 控件样式与 Artplayer 默认保持一致，必要时使用自定义 css 覆盖
2. 左下角在线人数
   - 采用半透明圆角小 badge，字体浅色，尺寸不抢眼但可辨识；点击可显示详情浮层（可选）
3. 通知条（notice）
   - 顶部横幅，白色滚动文本，右侧 30s 倒计时按钮，用户可提前关闭（记本地状态，避免重复展示）
4. 弹幕与工具栏
   - 桌面：工具栏显示更多按钮（求片、选集、弹幕开关、自定义工具等）
   - 移动：工具栏按钮收纳策略
     - 优先显示最常用的 3 个按钮（播放/暂停/设置），其余通过“更多”按钮弹出扩展工具栏（底部 sheet 或弹出菜单）
     - 求片按钮在移动端可放入扩展菜单或作为悬浮按钮
5. 求片抽屉 / 移动替代方案
   - PC：右侧抽屉（宽度 360-420px），打开时播放器暂停并在抽屉右上角提供关闭按钮
   - 移动：打开为全屏 modal（历史记录支持返回），确保聊天输入时软键盘不会遮挡重要控件
6. 选集展示
   - PC：在播放器上半透明 overlay 中显示分组资源（按 asset 分组），点击切换
   - 移动：在底部弹出 sheet 展示列表，支持手指滚动和快速切换
7. 启动广告 / 暂停广告
   - 启动广告优先遮罩层展示，可包含脚本注入，需能被关闭（按脚本或 CloseCode），且在关闭后立即开始播放器初始化

## 五、工程与依赖（建议）

- Node / npm
- Vue 3 + Vite 或 Vue CLI（当前项目使用 Vue CLI 风格，可继续）
- 主要 npm 包（示例，安装时请确认最新包名）：
  - artplayer
  - hls.js
  - flv.js
  - dashjs
  - webtorrent
  - mpegts.js（或 mpegts）
  - artplayer-plugin-danmuku
  - axios（或 fetch）
  - sass / postcss（如需）
- 推荐目录结构（基于当前项目）：
  - src/components/player/\* （播放器相关组件）
  - src/components/robot/\* （求片聊天相关）
  - src/services/api.js （封装接口请求）
  - src/plugins/artplayer.js（Artplayer 初始化与插件注册）
  - src/styles/\*

## 六、组件划分

- PlayerWrapper.vue：播放器容器，负责响应式布局、toolbar 管理、在线人数展示
- ArtPlayerCore.vue：封装 Artplayer 初始化、事件转发、格式适配、插件启用
- DanmakuLayer.vue：弹幕层封装（使用 artplayer-plugin-danmuku 或自定义）
- AdsManager.vue：广告展示处理（启动广告、暂停广告、pageAd 脚本注入）
- OnlineBadge.vue：左下角在线人数显示与定时刷新
- RobotDrawer.vue：求片聊天抽屉/移动 modal
- AssetPicker.vue：选集/线路选择 UI
- NoticeBar.vue：顶部通知条（倒计时、关闭）
- ApiService.js：所有远程接口调用，含重试与错误统一处理

## 七、容错与安全

- 网络请求超时、错误时需要合理回退（例如播放地址失败时切换备用 url）
- 对可执行脚本（pageAd、Script）要注意安全：在可控环境下执行并提供卸载/关闭方式；优先采用沙箱或 iframe 注入以降低风险
- 弹幕输入需过滤黑词、限制频率、防刷（前端限速，后端配合）

## 八、测试与验收标准

- 支持 HLS/FLV/DASH/WebTorrent/mpegts 中至少 3 种主流格式，播放流畅且能切换备用线路
- 弹幕能正常拉取与发送，黑词生效
- 在线人数在左下角可见且定时更新
- 求片抽屉在 PC 与移动端行为符合规范（PC 抽屉，移动全屏 modal），打开时播放器暂停，关闭恢复
- 配置下发（dmplay/config）正确生效（toolBars、notice、pageAd 等）
- 广告按概率展示并能关闭

## 九、开发任务拆分（建议）

1. 环境与依赖安装（1-2 天）
2. Artplayer 基础封装（1-2 天）
3. 多格式适配（hls/flv/dash/webtorrent/mpegts）（2-3 天）
4. 弹幕集成（1-2 天）
5. 在线人数组件 & 基础配置拉取（1 天）
6. 广告系统（启动/暂停/pageAd）（1-2 天）
7. 求片机器人抽屉与选集（2-3 天）
8. UI/响应式调优、测试与修复（2-3 天）

## 十二、项目目录结构说明（优化）

原简要目录（保留参考）

```
src/
  ├─ assets/                图片、静态资源
  ├─ libs/                  第三方库
  ├─ unit/                  自编 js 工具/库
  ├─ components/            ArtPlayer.vue / LivePlayer.vue 等
```

推荐分层（逐步演进）：

```
project-root/
├─ package.json              # 依赖与脚本命令
├─ vue.config.js / babel.config.js
├─ public/                   # 不经打包的公开资源与入口 index.html
├─ src/
│  ├─ main.js / App.vue      # 应用入口与根组件
│  ├─ assets/                # 打包参与的图片/字体等
│  ├─ styles/                # 全局样式、主题变量、mixins（建议新增）
│  ├─ components/            # 展示 + 轻交互组件
│  │  ├─ PlayerWrapper.vue   # 播放器外层/布局/工具栏协调
│  │  ├─ ArtPlayer.vue       # 点播播放器封装（调用工厂）
│  │  ├─ LivePlayer.vue      # 直播播放器（频道切换）
│  │  ├─ ChannelMenu.vue     # 频道菜单（直播）
│  │  ├─ DanmakuLayer.vue    # 弹幕层（初始化/黑词过滤桥接）
│  │  ├─ OnlineBadge.vue     # 在线人数角标 + 定时刷新
│  │  ├─ NoticeBar.vue       # 顶部公告 + 倒计时关闭
│  │  ├─ AdsManager.vue      # 启动/暂停广告与脚本注入
│  │  ├─ PauseAds.vue        # 暂停广告覆盖层
│  │  ├─ AssetPicker.vue     # 线路/选集切换 + 失败重试联动
│  │  ├─ RobotDrawer.vue     # 求片聊天抽屉 / 移动端全屏
│  │  ├─ ToolBarCustom.vue   # 自定义工具栏按钮集合（对接远程配置）
│  │  ├─ Message.vue / LoadingCover.vue / PageAdScript.vue 等辅助
│  ├─ services/              # 复杂业务与接口封装（建议从 unit 拆分）
│  │  ├─ api.js              # 拦截/超时/重试/签名
│  │  ├─ config.js           # 配置下发解析（notice/toolBars/pageAd）
│  │  ├─ ads.js              # 广告接口 + 权重概率逻辑
│  │  ├─ danmaku.js          # 弹幕获取/发送/频率与黑词过滤
│  │  ├─ online.js           # 在线人数轮询 & 数值平滑
│  │  └─ assets.js           # 播放线路管理与失败自动切换
│  ├─ plugins/               # 第三方库实例与适配层
│  │  ├─ artplayer.js        # 工厂 + customType + 插件注册
│  │  ├─ format-adapters.js  # hls/flv/dash/mpegts/webtorrent 适配集中
│  │  └─ danmaku-plugin.js   # 弹幕插件二次封装（参数/过滤）
│  ├─ unit/                  # 纯工具：getUrlEncry/节流/防抖/参数解析
│  └─ libs/                  # 本地改造第三方库（如需）
├─ doc/
│  ├─ 需求说明.md            # 业务与架构说明（本文件）
│  └─ artplayer/             # Artplayer 离线中文使用/示例文档
└─ README.md                 # 启动/构建/目录说明（建议新增）
```

使用原则：components 轻逻辑；services 处理签名/重试/过滤；plugins 统一第三方初始化；unit 纯函数；doc 只文档；styles 集中变量与主题。

## 十三、直播功能与频道菜单

- 支持直播流播放（如 m3u8、rtmp、flv 等直播格式）
- 频道菜单：
  - PC 端：频道菜单显示在播放器左侧，支持频道列表切换
  - 移动端：频道菜单显示在播放器下方，适配触屏操作
- 频道切换时自动切换直播流地址，支持频道名称、封面、热度等信息展示
- 直播播放器组件建议命名为 LivePlayer.vue，独立于普通视频播放器
- 失败重试：频道切换后若播放错误，按备用线路或下一频道来源重试；失败次数超限给出提示

## 十四、URL 参数控制说明（扩展）

- 支持通过 URL 参数控制播放内容：
  - `url=xxx`：直接播放指定视频地址（普通点播）
  - `url=xxx&live=1`：播放指定直播流（启用直播组件）
  - `channel=xxx`：指定初始频道（直播场景）
  - 可扩展：`line=2` 指定线路索引，`autoplay=1` 控制自动播放
- 参数优先级：URL 显式参数 > 本地缓存（最近一次选择） > 后端默认配置
- 初始化流程：解析参数 → 决定使用 ArtPlayer 或 LivePlayer → 加载频道/线路 → 拉取配置下发 → 初始化广告/弹幕

## 十五、组件划分建议（补充）

- ArtPlayer.vue：点播播放器（格式适配、弹幕、广告）
- LivePlayer.vue：直播播放器（频道、直播状态、低延迟策略）
- ChannelMenu.vue：频道展示与切换（含滚动与高亮）
- DanmakuLayer.vue：弹幕桥接层（仅负责 UI 与插件交互）
- AdsManager.vue：广告生命周期（启动/暂停/pageAd 注入/销毁）
- RobotDrawer.vue：求片聊天（暂停播放逻辑、关闭恢复）
- AssetPicker.vue：线路/资源列表（失败自动跳转下一个）
- OnlineBadge.vue：在线人数轮询与平滑动画
- NoticeBar.vue：滚动公告与倒计时关闭（记本地状态）
- ToolBarCustom.vue：远程配置 toolBars 注入自定义按钮

## 十六、交互与适配说明（补充）

- PC：频道菜单固定左侧，悬停可展开更多信息（可选）
- 移动：频道菜单底部横向滑动，支持触控滚动与快速切换
- 弹幕开关在移动端合并进“更多”底部弹出菜单，提高主栏简洁度
- 在线人数变化使用过渡动画（差值大时分步递增）
- 求片抽屉在移动端使用全屏并适配软键盘（输入框上移）
- 线路切换：失败事件捕获后延迟 1~2s 自动切换下一条并提示

## 十七、/doc/artplayer 目录说明（强化）

`/doc/artplayer` 为离线中文拆分文档，各 HTML 文件对应一个主题：

- 安装使用：初始化与最小示例
- 基础选项 / 高级属性：配置项与默认值（核对工厂参数）
- 控制器 / 设置面板 / 右键菜单：UI 扩展点与事件
- 实例事件 / 实例属性：播放生命周期、资源切换、错误、弹幕相关事件
- 静态属性 / 全局属性：全局扩展点（统一插件或主题）
- 编写插件：标准插件模式（广告、埋点、工具栏增强）
- 弹幕库：数据结构、速度、透明度、轨道、频率控制
- 业务层：组织播放器与业务逻辑示例
- 语言设置：多语言/文案替换方式
- \*\_files/：示例依赖资源（学习参考，生产需模块化）

使用建议：新增功能前检索相关章节；示例中的 DOM 操作统一改成插件或工厂封装；新格式支持集中在 `plugins/format-adapters.js`；广告脚本注入采用 iframe/CSP 与超时销毁策略；升级前对比官网与本地章节逐项验证。

## 十八、后续增强与测试建议

- README + CHANGELOG：记录启动命令与版本迭代
- ESLint + Prettier + EditorConfig：统一代码风格
- .env.[mode]：管理 baseUrl / debug / mock / 广告测试开关
- 单元测试优先：getUrlEncry、线路失败重试、弹幕黑词过滤、广告权重选择
- 性能：动态 import webtorrent；懒加载 RobotDrawer 内容；弹幕数据分页或分片加载
- 安全：弹幕与聊天文本进行基本 XSS 过滤；广告脚本沙箱
- 埋点：播放开始/结束、资源切换、弹幕发送、广告展示与关闭、频道切换

## 十九、版本规划示例

| 版本   | 目标     | 关键内容                                              |
| ------ | -------- | ----------------------------------------------------- |
| v4.0.0 | 核心落地 | 多格式播放 / 弹幕 / 在线人数 / 配置 / 广告 / 求片抽屉 |
| v4.1.0 | 直播完善 | LivePlayer + 频道菜单 + 直播弹幕适配                  |
| v4.2.0 | 体验增强 | 移动端优化 / 主题与多语言 / 基础埋点                  |
| v4.3.0 | 商业扩展 | 高级广告策略 / 智能线路优选 / 更多插件                |

---

以上优化补充在不改动前面业务描述的基础上增强架构清晰度与实施指引；`/doc/artplayer` 目录用作离线 API 与示例索引，开发时先查再写可降低试错成本。
