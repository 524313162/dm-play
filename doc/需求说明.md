# DMPlay-v4 播放器需求说明文档

> 技术栈：Vue 3 + Artplayer4（结合 hls.js、flv.js、dash.js、webtorrent、mpegts.js 等播放库）

## 一、项目概述

开发一个兼容 PC 与移动端的网页播放器，基于 Artplayer，实现 HLS、FLV、DASH、WebTorrent、mpegts 等多种流媒体格式播放；集成弹幕、广告、在线人数显示、机器人求片抽屉、远程配置下发等功能，界面美观、移动端友好。

## 二、关键功能

1. 基础播放控制（已具备）
   - 播放 / 暂停 / 跳转 / 音量 / 全屏 / 画中画 / 进度条 / 画面比例 等。
2. 格式支持（必须）
   - HLS（hls.js）
   - FLV（flv.js）
   - DASH（dash.js）
   - WebTorrent（webtorrent）
   - mpegts（mpegts.js）
   - 以上格式需在 npm 上安装对应库（见后面依赖清单）并在 Artplayer 中按需启用插件/adapter。
3. 弹幕
   - 使用 npm 包：`artplayer-plugin-danmuku`（或 artplayer 官方推荐插件）
   - 支持拉取弹幕列表、发送弹幕接口、黑词过滤、提示文案、开关控制等
4. 在线人数角标（左下）
   - 常驻左下角，颜色淡雅（半透明背景、浅色文字），接口：
     https://dmplay.knowhub.vip/Online/Index?timespan=...&urlEncry=...
   - 接口返回格式：`{"code":1,"data":38}`，当 code=1 时显示 data
   - 定时刷新（例如每 15-30 秒）并平滑更新数字
5. 基础配置下发
   - 接口：https://dmplay.knowhub.vip/api/v1.0/dmplay/config?timespan=...&urlEncry=...
   - 返回结构示例（摘录）包含 ad、notice、danmuOn、danmuApi、toolBars 等
   - 在播放器初始化时拉取配置并据此：
     - 注入 pageAd 脚本（注意安全与沙箱）
     - 显示 notice（顶部滚动白色文字，右侧显示倒计时 30s，可提前关闭）
     - 初始化 toolBars（在控制栏上添加按钮，支持 icon 或 title、link）
     - 拷贝 copywriting 到剪贴板（随机选择一项）
     - 控制 danmu 功能开关和 danmuApi
6. 广告系统
   - 接口：GET https://dmplay.knowhub.vip/api/v1.0/Ads/Index?id=1&platform=web... 返回 {width,height,Script,CloseCode,ID,Weight}
   - 展示逻辑：根据 Weight 概率决定是否展示，按 width/height 限定尺寸，Script 中的代码执行/注入，CloseCode 为可选关闭逻辑
   - 支持启动广告（startAds）、暂停广告（pauseAds）等
7. 求片机器人抽屉
   - 点击“求片”按钮弹出抽屉（PC 侧边抽屉；移动端弹出 full-screen modal/page）
   - 弹出时暂停播放，关闭时恢复播放
   - 抽屉内为聊天窗口：输入关键词调用搜索接口，展示搜索结果；点击结果请求影片资源（POST /dmjx/index?id=...），并在播放器上切换资源（支持多线路与备用列表）
8. 选集/线路切换
   - 支持 assets 数组展示（半透明覆盖层或弹出菜单），点击切换至对应 url
   - 自动失败重试：当前 URL 播放失败时自动尝试 assets 列表的下一个
9. 加载过渡图（友好效果）
   - 接口：GET https://dmplay.knowhub.vip/api/v1.0/cover/images
   - 返回图片数组，播放器加载/缓冲时随机显示一张并每 3 秒切换
   - 可使用 Artplayer 的 loading 插件或自定义 overlay 实现


## 三、API 细节（已知）

### timespan & urlEncry 参数说明

- **timespan**：当前系统时间戳（毫秒，`Date.now()`）
- **urlEncry**：所有参数升序排列后拼接字符串，取 md5 值。
  - 生成方法：
    1. 获取 url 查询参数（不含 urlEncry），每项拼接为 key+value
    2. 追加额外参数（如 timespan）
    3. 所有 key+value 组成数组，按字典序排序
    4. 用英文逗号 `,` 连接
    5. 对结果字符串做 md5 得到 urlEncry
  - 示例代码：
```js
function getUrlEncry(urlStr, values) {
    let url = ''
    if (typeof urlStr === 'undefined') {
        url = decodeURI(location.search)
    } else {
        const arr = urlStr.split('?')
        if (arr.length >= 2) {
            let q = arr[1] || ''
            if (q !== '') {
                url = '?' + q
            }
        }
    }
    let querys = []
    if (url.indexOf('?') !== -1) {
        var str = url.substr(1)
        let strs = str.split('&')
        for (var i = 0; i < strs.length; i++) {
            let arr = strs[i].split('=')
            if (arr[0] === 'urlEncry') {
                continue
            }
            querys.push(arr[0] + decodeURI(arr[1]))
        }
    }
    for (var v in values) {
        querys.push(v + values[v])
    }
    querys = querys.sort(function (a, b) {
        return a.localeCompare(b)
    })
    let res = querys.join(',')
    let md5Str = md5lib(res)
    return md5Str
}
```
  - 依赖：需引入 md5 库（如 `md5` npm 包或自定义 md5lib）

- 在线人数：
  - GET https://dmplay.knowhub.vip/Online/Index?timespan=...&urlEncry=...
  - 返回：{"code":1,"data":38}
- 配置：
  - GET https://dmplay.knowhub.vip/api/v1.0/dmplay/config?timespan=...&urlEncry=...
  - 返回示例见需求描述（包含 ad、notice、danmu...）
- 广告：
  - GET https://dmplay.knowhub.vip/api/v1.0/Ads/Index?id=1&platform=web&timespan=...&urlEncry=...
  - POST 广告上报/点击（如需）
- 弹幕：
  - GET https://dmplay.knowhub.vip/api/v1.0/Danmu?id=&timespan=...&urlEncry=...
  - POST https://dmplay.knowhub.vip/api/v1.0/Danmu（body JSON: text, mode, color, vodId, time）
- 聊天求片：
  - GET https://dmplay.knowhub.vip/api/v1.0/Chat/Index?qes=...&timespan=...&urlEncry=...
  - POST https://dmplay.knowhub.vip/api/v1.0/dmjx/index (body: id=...) 返回资源列表

注意：所有跨域请求需后端配置 CORS 或前端通过代理转发；需要对接口错误/超时做容错处理。

## 四、UI / 交互与移动端适配

1. 通用风格
   - 大气、简洁、以深色或暗色主题为主（更适合视频场景）
   - 控件样式与 Artplayer 默认保持一致，必要时使用自定义 css 覆盖
2. 左下角在线人数
   - 采用半透明圆角小 badge，字体浅色，尺寸不抢眼但可辨识；点击可显示详情浮层（可选）
3. 通知条（notice）
   - 顶部横幅，白色滚动文本，右侧 30s 倒计时按钮，用户可提前关闭（记本地状态，避免重复展示）
4. 弹幕与工具栏
   - 桌面：工具栏显示更多按钮（求片、选集、弹幕开关、自定义工具等）
   - 移动：工具栏按钮收纳策略
     - 优先显示最常用的 3 个按钮（播放/暂停/设置），其余通过“更多”按钮弹出扩展工具栏（底部 sheet 或弹出菜单）
     - 求片按钮在移动端可放入扩展菜单或作为悬浮按钮
5. 求片抽屉 / 移动替代方案
   - PC：右侧抽屉（宽度 360-420px），打开时播放器暂停并在抽屉右上角提供关闭按钮
   - 移动：打开为全屏 modal（历史记录支持返回），确保聊天输入时软键盘不会遮挡重要控件
6. 选集展示
   - PC：在播放器上半透明 overlay 中显示分组资源（按 asset 分组），点击切换
   - 移动：在底部弹出 sheet 展示列表，支持手指滚动和快速切换
7. 启动广告 / 暂停广告
   - 启动广告优先遮罩层展示，可包含脚本注入，需能被关闭（按脚本或 CloseCode），且在关闭后立即开始播放器初始化

## 五、工程与依赖（建议）

- Node / npm
- Vue 3 + Vite 或 Vue CLI（当前项目使用 Vue CLI 风格，可继续）
- 主要 npm 包（示例，安装时请确认最新包名）：
  - artplayer
  - hls.js
  - flv.js
  - dashjs
  - webtorrent
  - mpegts.js（或 mpegts）
  - artplayer-plugin-danmuku
  - axios（或 fetch）
  - sass / postcss（如需）
- 推荐目录结构（基于当前项目）：
  - src/components/player/*  （播放器相关组件）
  - src/components/robot/*   （求片聊天相关）
  - src/services/api.js      （封装接口请求）
  - src/plugins/artplayer.js（Artplayer 初始化与插件注册）
  - src/styles/*

## 六、组件划分

- PlayerWrapper.vue：播放器容器，负责响应式布局、toolbar 管理、在线人数展示
- ArtPlayerCore.vue：封装 Artplayer 初始化、事件转发、格式适配、插件启用
- DanmakuLayer.vue：弹幕层封装（使用 artplayer-plugin-danmuku 或自定义）
- AdsManager.vue：广告展示处理（启动广告、暂停广告、pageAd 脚本注入）
- OnlineBadge.vue：左下角在线人数显示与定时刷新
- RobotDrawer.vue：求片聊天抽屉/移动 modal
- AssetPicker.vue：选集/线路选择 UI
- NoticeBar.vue：顶部通知条（倒计时、关闭）
- ApiService.js：所有远程接口调用，含重试与错误统一处理

## 七、容错与安全

- 网络请求超时、错误时需要合理回退（例如播放地址失败时切换备用 url）
- 对可执行脚本（pageAd、Script）要注意安全：在可控环境下执行并提供卸载/关闭方式；优先采用沙箱或 iframe 注入以降低风险
- 弹幕输入需过滤黑词、限制频率、防刷（前端限速，后端配合）

## 八、测试与验收标准

- 支持 HLS/FLV/DASH/WebTorrent/mpegts 中至少 3 种主流格式，播放流畅且能切换备用线路
- 弹幕能正常拉取与发送，黑词生效
- 在线人数在左下角可见且定时更新
- 求片抽屉在 PC 与移动端行为符合规范（PC 抽屉，移动全屏 modal），打开时播放器暂停，关闭恢复
- 配置下发（dmplay/config）正确生效（toolBars、notice、pageAd 等）
- 广告按概率展示并能关闭

## 九、开发任务拆分（建议）

1. 环境与依赖安装（1-2 天）
2. Artplayer 基础封装（1-2 天）
3. 多格式适配（hls/flv/dash/webtorrent/mpegts）（2-3 天）
4. 弹幕集成（1-2 天）
5. 在线人数组件 & 基础配置拉取（1 天）
6. 广告系统（启动/暂停/pageAd）（1-2 天）
7. 求片机器人抽屉与选集（2-3 天）
8. UI/响应式调优、测试与修复（2-3 天）

## 十、附录：注意事项

- 不同浏览器与移动设备的 autoplay 策略不同，需处理静音自动播放逻辑与用户操作触发播放
- WebTorrent 在移动端资源占用高，可能存在兼容与性能问题；必要时提供回退方案
- mpegts.js 的集成要注意浏览器 Media Source Extensions (MSE) 支持情况

## 十一、Artplayer 使用说明

### 1. 安装方式

- 推荐使用 npm 安装：
  ```bash
  npm install artplayer
  # 格式支持插件
  npm install hls.js flv.js dashjs webtorrent mpegts.js artplayer-plugin-danmuku
  ```
- 也可通过 CDN 引入（不推荐生产环境）：
  ```html
  <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
  ```

### 2. 基础用法（Vue3 组件示例）

```js
import Artplayer from 'artplayer';
import Hls from 'hls.js';
import FlvJs from 'flv.js';
import DashJs from 'dashjs';
import WebTorrent from 'webtorrent';
import Mpegts from 'mpegts.js';
import artplayerPluginDanmuku from 'artplayer-plugin-danmuku';

onMounted(() => {
  const art = new Artplayer({
    container: this.$refs.player,
    url: '视频地址',
    poster: '封面图',
    autoplay: false,
    theme: '#23ade5',
    volume: 0.8,
    isLive: false,
    muted: false,
    setting: true,
    playbackRate: true,
    aspectRatio: true,
    fullscreen: true,
    miniProgressBar: true,
    plugins: [
      artplayerPluginDanmuku({
        danmuku: [], // 弹幕数据
        speed: 5,
        opacity: 0.7,
        fontSize: 24,
        color: '#fff',
        // ...更多配置
      })
    ],
    customType: {
      m3u8: function (video, url) {
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
        }
      },
      flv: function (video, url) {
        if (FlvJs.isSupported()) {
          const flvPlayer = FlvJs.createPlayer({ type: 'flv', url });
          flvPlayer.attachMediaElement(video);
          flvPlayer.load();
        }
      },
      dash: function (video, url) {
        const player = DashJs.MediaPlayer().create();
        player.initialize(video, url, false);
      },
      mpegts: function (video, url) {
        if (Mpegts.isSupported()) {
          const player = Mpegts.createPlayer({ url });
          player.attachMediaElement(video);
          player.load();
        }
      },
      torrent: function (video, url) {
        const client = new WebTorrent();
        client.add(url, function (torrent) {
          const file = torrent.files.find(f => f.name.endsWith('.mp4'));
          file.renderTo(video);
        });
      }
    }
  });
});
```

### 3. 常用选项说明

- container：播放器容器元素（必填）
- url：视频地址（支持 m3u8、flv、mp4、webtorrent、mpegts 等）
- poster：封面图片
- autoplay：自动播放
- theme：主题色
- volume：初始音量
- isLive：直播模式
- muted：静音
- setting：显示设置面板
- playbackRate：倍速播放
- aspectRatio：画面比例
- fullscreen：全屏
- miniProgressBar：迷你进度条
- plugins：插件数组（如弹幕、loading、广告等）
- customType：自定义格式适配（如 hls、flv、dash、webtorrent、mpegts）

### 4. 插件扩展

- 弹幕插件：artplayer-plugin-danmuku
- 加载动画插件、广告插件、右键菜单、设置面板等可参考官方文档或自定义

### 5. 事件与实例属性

- 事件监听：
  ```js
  art.on('play', () => { /* 播放事件 */ });
  art.on('pause', () => { /* 暂停事件 */ });
  art.on('error', (err) => { /* 错误处理 */ });
  art.on('switch', (url) => { /* 切换资源 */ });
  ```
- 实例属性：
  - art.play() / art.pause()
  - art.setUrl(url)
  - art.getCurrentTime()
  - art.fullscreen.toggle()
  - art.setting.show()
  - art.plugins

### 6. 右键菜单、设置面板、全局属性

- 支持自定义右键菜单、设置面板内容
- 全局属性可通过 Artplayer 静态属性扩展

### 7. 编写自定义插件

```js
Artplayer.plugin('myPlugin', (art) => {
  // 插件逻辑
});
```

更多详细内容请参考 Artplayer 官方文档：https://artplayer.org/document

## 十二、项目目录结构说明

- src/                // 主程序目录
  - assets/           // 图片、静态资源
  - libs/             // 第三方库
  - unit/             // 自编 js 工具/库
  - components/       // 组件资源
    - ArtPlayer.vue   // 普通视频播放器组件
    - LivePlayer.vue  // 直播播放器组件（需新增）
    - ...             // 其他功能组件

## 十三、直播功能与频道菜单

- 支持直播流播放（如 m3u8、rtmp、flv 等直播格式）
- 频道菜单：
  - PC端：频道菜单显示在播放器左侧，支持频道列表切换
  - 移动端：频道菜单显示在播放器下方，适配触屏操作
- 频道切换时自动切换直播流地址，支持频道名称、封面、热度等信息展示
- 直播播放器组件建议命名为 LivePlayer.vue，独立于普通视频播放器

## 十四、url参数控制说明

- 支持通过 url 参数控制播放内容：
  - `url=xxx`：直接播放指定视频地址（普通点播）
  - `url=xxx&live=1`：播放指定直播流地址，自动切换为直播播放器组件
- 页面初始化时自动识别 url 参数，决定加载普通播放器或直播播放器
- 频道菜单支持通过参数 `channel=xxx` 切换频道（可扩展）

## 十五、组件划分建议（补充）

- ArtPlayer.vue：普通视频播放器，支持点播、格式适配、弹幕、广告等
- LivePlayer.vue：直播播放器，支持频道菜单、直播流切换、弹幕（如需）
- ChannelMenu.vue：频道菜单组件，负责频道列表展示与切换（PC/移动端自适应）
- 其他功能组件按需拆分

## 十六、交互与适配说明

- PC端频道菜单在播放器左侧，支持鼠标点击切换
- 移动端频道菜单在播放器下方，支持触屏滑动与点击
- 频道菜单样式需美观、响应式，支持频道封面、名称、热度等展示
- 直播流切换需无缝、快速，支持错误提示与重试


## 十七、 artplayer文档目录
/doc/artplayer目录下的内容，你可以阅读以方便知道如何使用artplayer播放器